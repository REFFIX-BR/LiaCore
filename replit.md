# LIA CORTEX - AI Orchestration Platform

## Overview
LIA CORTEX is an enterprise-grade AI middleware orchestration platform for TR Telecom's customer service. It automates Q&A and actions using OpenAI's Assistants API and a RAG knowledge base through specialized AI assistants. The platform features a real-time supervisor monitoring dashboard and an autonomous continuous learning system, aiming to enhance customer service efficiency and satisfaction in telecommunications.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
### UI/UX Decisions
The frontend uses React, TypeScript, Vite, `shadcn/ui`, and Tailwind CSS, inspired by Carbon Design System and Linear, supporting dark/light modes. `Wouter` handles routing. Key UI features include color-coded wait time indicators, enhanced complaint description UI, dialogs for private notes, dedicated UIs for new contact creation, conversation reopening, and activity logs. Sales and plans management systems offer dashboards with KPIs, tables, and CRUD interfaces. The chat interface provides message pagination with intelligent auto-scroll, auto-focus textarea, and inline PDF visualization.

### Technical Implementations
**Frontend**: TanStack Query for server state management.
**Backend**: Node.js and Express.js (TypeScript) integrating GPT-5 for routing, OpenAI Assistants API, Upstash Vector for RAG, Upstash Redis for conversation threads, and PostgreSQL via Drizzle ORM.
**Queue System**: BullMQ with Redis TLS for asynchronous processing, retries, and webhooks.
**AI & Knowledge Management**: OpenAI Assistants API orchestrates six AI roles using a "Receptionist-First" routing model. A dual-layer RAG architecture with Upstash Vector supports specific knowledge bases. Custom function calling enables verification, knowledge queries, invoice lookups, scheduling, sales operations, and **automated ticket creation in CRM**. Automated systems include document detection, "Boleto Consultation," "PPPoE Connection Status," "Unlock/Unblock," HTTP Resilience, GPT-4o Vision, PDF text extraction, and OpenAI Whisper. Conversation intelligence provides real-time sentiment analysis, urgency detection, problem identification, and automatic persistence of CPF/CNPJ. **CRITICAL FIX (Oct 27, 2025)**: Intelligent routing context preservation - when routing between assistants (e.g., Presentation â†’ Support), system now injects complete `routingReason` instead of just customer's reply, ensuring destination assistant receives full problem context (e.g., "Cliente sem internet no endereÃ§o PILÃ•ES - SANTA EFIGÃŠNIA, 352" instead of just "2"). System intelligently preserves original customer message only when it contains information beyond simple selection numbers. **NEW (Oct 27, 2025)**: Automated Ticket Creation System - AI assistants can now open tickets directly in the external CRM (https://webhook.trtelecom.net/webhook/abrir_ticket) when customers send payment receipts or request formal service records. System validates 9 department-reason combinations with automatic CPF/CNPJ capture, retry logic, and LGPD-compliant logging. Primary use cases: FINANCEIRO (payment proof processing) and SUPORTE (resolved technical issues). **ENHANCED (Oct 27, 2025)**: WhatsApp phone number automatically included in ticket summary - system extracts from chatId and prepends `[WhatsApp: nÃºmero]` to all CRM tickets for easy customer identification and traceability. **NEW (Oct 27, 2025)**: Comprovante link auto-inclusion - when customers send payment receipts (images/PDFs), system automatically stores S3 link in conversation metadata and appends to ticket summary format `ðŸ“Ž Comprovante: https://s3.trtelecom.net/...` with 3-layer security validation: (1) existence check, (2) legacy metadata protection (ignores links without timestamp), (3) 5-minute freshness check. Auto-cleanup after ticket creation prevents link reuse. **CRITICAL UPDATE REQUIRED (Oct 27, 2025)**: FINANCEIRO assistant instructions updated to prevent double-action bug (calling both `abrir_ticket_crm` + `transferir_para_humano`) and enforce address confirmation for multi-point customers before ticket creation. OpenAI assistant `asst_pRXVhoy1o4YxNxVmaRiNOTMX` MUST be updated with new instructions from `INSTRUCOES_ASSISTENTES_OPENAI_OTIMIZADO.md` (lines 608-1052). **CRITICAL FIX (Oct 27, 2025 - Michele Machado case)**: FINANCEIRO assistant now enforces strict mathematical CPF/CNPJ validation using new `validar_cpf_cnpj` function with full check-digit algorithm implementation. Added REGRA #0 requiring assistants to: (1) verify CPF was typed by customer (NEVER trust OCR), (2) call `validar_cpf_cnpj` before opening tickets, (3) reject invalid CPFs including sequences (111.111.111-11) and incorrect check-digits (e.g., barcode "00000007990"), (4) transfer to human after 2 refusals. Added REGRA #5 to prevent premature conversation finalization. Function `validarCpfCnpj` implemented in `server/ai-tools.ts` with algorithms for CPF (weights 10â†’2, 11â†’2) and CNPJ (cyclic 5..2/9..2), registered in `executeAssistantTool`. See ATUALIZACAO_ASSISTENTE_FINANCEIRO_URGENTE.md for complete update guide and 4 regression test scenarios.
**Real-Time Monitoring**: Supervisor Dashboard offers KPIs, live queues, alerts, transcripts, human intervention controls, and a Live Logs System. The Monitor features a 6-state view mode system: (1) Todas (all active + resolved), (2) IA Atendendo (AI-only conversations), (3) Aguardando (transfer queue), (4) Em Atendimento (agent-assigned), (5) Finalizadas (resolved, 12h retention), and **NEW** (6) HistÃ³rico Completo (ALL conversations from database with pagination, independent search, 50 per page, no time limit - for long-term audit and regulatory compliance).
**Continuous Learning System**: A GPT-4 agent suggests prompt improvements.
**Hybrid Supervised Mode**: Manages "Transferred" and "Assigned" conversations with AI-assisted agent responses.
**WhatsApp Integration**: Native integration with Evolution API for messaging, AI routing, outbound messages, triple-fallback delivery, and group management.
**Role-Based Access Control (RBAC)**: A 3-tier system (ADMIN, SUPERVISOR, AGENT) with granular permissions and department-based access control.
**Contact Management System**: Centralized client database with automatic WhatsApp contact sync and bidirectional synchronization with conversations.
**Message Deletion System**: Supervisors/admins can soft-delete assistant messages.
**Redis Optimization System**: Intelligent caching, batching, and hash storage.
**Message Batching System**: Atomic Redis-based debouncing groups sequential client messages.
**Private Notes System**: Internal collaboration feature.
**Conversation Verification System**: Supervisor workflow to mark conversations as reviewed.
**Activity Logs & Audit System**: Comprehensive audit trail with a dual-tab interface and KPI dashboard.
**Conversational Sales System**: Autonomous AI for lead qualification, plan presentation, data collection, and sales processing via WhatsApp.
**Multiple Points Detection System**: Automatically detects customers with multiple internet installations.
**Lead Capture System**: Comprehensive system for capturing and managing incomplete sales prospects.
**Ephemeral Installation Point Selection System (Boletos)**: Uses Redis ephemeral storage to allow customers with multiple installation points to select an address for each boleto query, bypassing AI processing.
**Regional Massive Failure System**: Automated detection and notification system for service outages, including visual region selection, automatic client notification via WhatsApp, and intelligent region matching. **CRITICAL FIX (Oct 26, 2025)**: System now verifies ALL installation points for massive failures, even when customers have multiple addresses. Previously, multi-point customers were only given AI context without actual failure verification. Now detects failures in any point and notifies customers with specific affected addresses.
**Assistants Page Filter System (Oct 27, 2025)**: Fixed two critical bugs on /assistants page: (1) **Initial loading bug**: queryFn missing `credentials: "include"` caused silent authentication failures. Fixed by adding credentials to fetch in Assistants.tsx and AgentReports.tsx. (2) **"Hoje" filter infinite loop**: getDateRange() generated new timestamps every render, causing queryKey to change constantly and trigger infinite refetch loop. Fixed using useMemo to memoize dates with fixed end-of-day timestamps (23:59:59) instead of dynamic Date() objects. Solution also includes: structured queryKey with serializable primitives, retry: false for fast failure detection, and proper enabled flag for custom period validation. All period filters (Hoje, Semana, MÃªs, Todos, Custom) now functional with stable queryKey and proper cache invalidation.
**ApresentaÃ§Ã£o Assistant Optimization (Oct 27, 2025)**: Comprehensive performance improvement to address 39.3% success rate and 41-minute average routing time. Three critical updates to INSTRUCOES_ASSISTENTES_OPENAI_OTIMIZADO.md: (1) **"VocÃª estÃ¡ aÃ­?" prohibition strengthened** - Added explicit violation warnings with 7+ forbidden variations and real negative examples from production conversations where assistant asked "vocÃª estÃ¡ aÃ­?" after customer already responded. (2) **Direct routing implementation** - Keyword-based instant routing without intermediate questions (e.g., "comprovante"â†’Financeiro, "sem internet"â†’Suporte, "religamento"â†’Financeiro) to reduce 41min average to <2min target. (3) **Automatic finalization after routing** - Clear rules for calling finalizar_conversa when customer responds "ok/obrigado/blz" after successful routing, preventing 26.3% conversations stuck in active state. Added finalizar_conversa to ApresentaÃ§Ã£o's available tools matrix. Includes 4 real error examples from production (perguntar "vocÃª estÃ¡ aÃ­?", mÃºltiplas perguntas antes de rotear, nÃ£o finalizar apÃ³s "ok obg", rotear 2x) with correct alternatives. **REQUIRES MANUAL UPDATE**: OpenAI assistant asst_APRESENTACAO_ID must be updated with new instructions and have finalizar_conversa function added in platform.openai.com/assistants. Expected improvements: 55-65% success rate (â†‘15.7%), <2min routing time (â†“95%), <10% active conversations (â†“16.3%).
**Announcements/Communications System**: Centralized system for company-wide announcements with priority-based rotation display. Features include: (1) Banner component that alternates between active announcements and massive failures (5-second rotation), (2) Full CRUD admin interface (restricted to ADMIN/SUPERVISOR roles), (3) Announcement types (info, warning, alert, success) with customizable priority, (4) Active/inactive toggle and date-range scheduling, (5) Persistent PostgreSQL storage with automatic filtering, (6) Visual banner with color-coded styles and smooth fade transitions.

### System Design Choices
- **Admin Tools**: Features for mass-closing abandoned conversations, reprocessing stuck messages, and configuration management.
- **Media Handling**: Supervisors can download WhatsApp images and PDFs, with inline PDF viewing.
- **Worker Concurrency**: Optimized for messages, images, and NPS workers.
- **API Key Management**: Robust handling of multi-instance Evolution API keys.
- **Security & Compliance**: LGPD/GDPR-compliant logging ensures no personal/financial data in logs, only aggregate metrics. Debug endpoints are protected, and structured error handling prevents sensitive data exposure to AI assistants.

## External Dependencies

**Third-Party Services**:
- **OpenAI**: AI Assistants API.
- **Upstash Vector**: Serverless vector database.
- **Upstash Redis**: Serverless Redis.
- **Neon Database**: Serverless PostgreSQL.
- **Evolution API**: WhatsApp integration.

**Key NPM Packages**:
- `@radix-ui/*`: Headless UI components.
- `@tanstack/react-query`: Server state management.
- `drizzle-orm`: Type-safe ORM.
- `express`: Web server framework.
- `react-hook-form`, `zod`: Form handling and validation.
- `tailwindcss`: CSS framework.