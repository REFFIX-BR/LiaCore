# LIA CORTEX - AI Orchestration Platform

## Overview
LIA CORTEX is an enterprise-grade AI middleware orchestration platform designed for TR Telecom's customer service. It leverages specialized AI assistants powered by OpenAI's Assistants API and a RAG knowledge base to automate Q&A and actions. The platform includes a real-time supervisor monitoring dashboard and an autonomous continuous learning system, aiming to significantly improve customer service efficiency and satisfaction in the telecommunications sector through advanced AI orchestration.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
### UI/UX Decisions
The frontend, built with React, TypeScript, Vite, `shadcn/ui`, and Tailwind CSS, draws inspiration from Carbon Design System and Linear, supporting dark/light modes. Key features include color-coded wait times, enhanced complaint descriptions, private note dialogs, new contact creation, conversation reopening, and activity logs. Sales and plans management offer dashboards with KPIs and CRUD interfaces. The chat interface provides message pagination, auto-scroll, auto-focus, and inline PDF viewing. The agent conversation interface offers flexible layout modes (single-box for focus, dual-box for multitasking), with preferences persisted locally.

### Technical Implementations
**Frontend**: Uses TanStack Query for server state management.
**Backend**: Node.js and Express.js (TypeScript) integrate GPT-5 for routing, OpenAI Assistants API, Upstash Vector for RAG, Upstash Redis for conversation threads, and PostgreSQL via Drizzle ORM.
**Queue System**: BullMQ with Redis TLS handles asynchronous processing.
**AI & Knowledge Management**: Orchestrates **seven specialized AI assistants** using OpenAI Assistants API with a "Receptionist-First" routing model: Cortex (receptionist), ApresentaÃ§Ã£o, Comercial, Financeiro, Suporte, Ouvidoria, Cancelamento, and **CobranÃ§a** (dedicated debt collection negotiation). A dual-layer RAG architecture with Upstash Vector supports specific knowledge bases. Custom function calling enables verification, knowledge queries, invoice lookups, scheduling, sales operations, automated CRM ticket creation, service order (OS) status checks, and **payment promise registration**. Automated systems include document detection, "Boleto Consultation," "PPPoE Connection Status," "Unlock/Unblock," "Service Order Status," HTTP Resilience, GPT-4o Vision, PDF text extraction, and OpenAI Whisper. Conversation intelligence provides real-time sentiment analysis, urgency detection, problem identification, and automatic persistence of CPF/CNPJ. The system preserves full context during assistant routing and automatically creates CRM tickets. It handles multiple installation points by discretely asking "Which address has the problem?" and using `selecionar_ponto_instalacao`. The knowledge base automatically loads all documents on mount using parallel semantic queries.
**AI-to-AI Routing**: Specialized assistants can route out-of-scope requests to peer AI assistants using `rotear_para_assistente`, reserving `transferir_para_humano` for explicit human requests or manual-only actions.
**Prompt Management System**: Features an AI-powered prompt editor with version control, draft workflows, semantic versioning, GPT-4o AI analysis for recommendations, real-time token counting, and automatic OpenAI Assistants API synchronization. The evolution consolidation system uses intelligent deduplication (Jaccard similarity, 70% threshold) before GPT-4o processing to eliminate duplicates, and immediately marks all processed suggestions as "consolidated" to prevent reprocessing.
**Context Quality Monitoring System**: Automated real-time monitoring of AI conversation context with detectors for duplicate data requests, ignored history, duplicate routing, and context reset, providing AI-powered prompt correction suggestions.
**Gamification System**: Automated performance ranking with a configurable V2 system for scoring parameters (e.g., NPS, Volume, Resolution Rate) and a badge system.
**Real-Time Monitoring**: The Supervisor Dashboard offers KPIs, live queues, alerts, transcripts, human intervention controls, and a Live Logs System with a 6-state view including "HistÃ³rico Completo".
**Agent Dashboard Enhancements**: Supports period-based filtering (daily/weekly/monthly) for performance metrics, including accurate TMA calculation and period-aware metrics aggregation.
**Continuous Learning System**: A GPT-4 agent suggests prompt improvements.
**Hybrid Supervised Mode**: Manages "Transferred" and "Assigned" conversations with AI-assisted agent responses.
**WhatsApp Integration**: Native integration with Evolution API supporting 3 WhatsApp instances (Leads, Cobranca, Principal) with end-to-end instance routing.
**Role-Based Access Control (RBAC)**: A 3-tier system (ADMIN, SUPERVISOR, AGENT) with granular permissions.
**Contact Management System**: Centralized client database with automatic WhatsApp contact sync.
**Announcements/Communications System**: Centralized system for company-wide announcements with priority-based rotation.
**COBRANÃ‡AS - Autonomous Debt Collection Module**: Production-ready implementation with **dedicated IA CobranÃ§a assistant** (`OPENAI_COBRANCA_ASSISTANT_ID`) specialized in empathetic debt negotiation, payment promise registration, and compliance with ANATEL/LGPD regulations. Supports proactive voice calls (Twilio + OpenAI Realtime API) and automated WhatsApp messaging (Evolution API). Features include 6 BullMQ workers, a hybrid routing system based on `contactMethod`, a WhatsApp Collection Worker with **dual pre-send verification** (1. queries CRM API to skip already-paid clients, 2. checks for active payment promises to avoid duplicate contact during promise period), a centralized WhatsApp module, UI contact method selector, Twilio integration with secure webhooks, OpenAI Realtime API via WebSocket, session security, ANATEL compliance, graceful degradation, and campaign management with statistics auto-recalculation. The **IA CobranÃ§a** uses a humanized conversation flow: greeting â†’ identity confirmation â†’ **automatic invoice query via CPF** â†’ empathetic negotiation â†’ **payment promise registration**. **Payment Promise System - Complete Lifecycle Management**: (1) **Single Promise Enforcement**: Clients can only have ONE active promise at a time - attempting to create additional promises returns clear error message. (2) **Automated Promise Registration**: IA CobranÃ§a detects payment dates and immediately calls `registrar_promessa_pagamento` (stores CPF/CNPJ, due date at 23:59:59, amount, method). (3) **Multi-Layer Protection**: WhatsApp worker checks: feature flag â†’ target state â†’ max attempts â†’ business hours â†’ **payment verification via CRM** (skips already-paid) â†’ **active promises** (blocks if status='pending' AND dueDate >= today). (4) **Unified Promise Monitor Worker**: Runs scheduled checks to (a) send WhatsApp reminders on due date, (b) verify payment via CRM after expiration, (c) mark as 'fulfilled' if paid or 'broken' if not, with **critical safety**: only processes when CRM verification succeeds - if CRM fails, promise is skipped and retried later to prevent false-positive collections. (5) **Automatic Breach Detection**: Broken promises (status='broken') remove protection allowing daily collection messages until payment. (6) **Promise States**: pending â†’ reminderSent â†’ fulfilled OR broken. The AI can autonomously update campaign target status using the `atualizar_status_cobranca` tool when it detects payment has been completed, automatically marking targets as 'paid' to prevent duplicate contact. **Complete Isolation from Regular Support**: Conversations from campaigns (`conversationSource: 'whatsapp_campaign'` or `'voice_campaign'`) are **completely excluded** from the Supervisor Dashboard (`getMonitorConversations`) to prevent pollution of regular support workflows. **Dedicated Monitor de CobranÃ§as** at `/voice/monitor` provides unified metrics (calls vs WhatsApp messages, pending promises, conversion rate), conversation table with source filtering (inbound/voice_campaign/whatsapp_campaign), and direct transfer capabilities. The Supervisor Dashboard displays a real-time badge alerting pending payment promises with quick access to the cobranÃ§as monitor. Initial messages from the WhatsApp worker are persisted to the OpenAI thread context to ensure the IA CobranÃ§a has full conversation history when clients respond.
**Messaging Control Center**: Professional control panel for flexible contact method management with global and per-campaign configuration, including global settings (voice/WhatsApp toggles, default method, fallback order), per-campaign overrides (allowedMethods, fallbackOrder in VoiceCampaigns drawer), backend validation (prevents activation if configured methods globally disabled, validates BEFORE database update), and method-specific statistics API (GET /api/voice/stats returns separated metrics by contactMethod with backward compatibility). **Unified Metrics API** (GET /api/voice/metrics) aggregates total calls, WhatsApp messages, pending/fulfilled promises, conversion rate, and channel breakdown for comprehensive reporting.
**Campaign Conversation Tracking**: Complete integration between voice campaigns and cobranÃ§as monitoring. Conversations table includes `conversationSource` field (values: 'inbound', 'voice_campaign', 'whatsapp_campaign') and `voiceCampaignTargetId` for bidirectional linking with campaign targets. The **routing system automatically directs** campaign-sourced conversations to the **IA CobranÃ§a** assistant for specialized negotiation. WhatsApp collection worker creates conversations before sending messages, registering initial collection messages and linking to campaign targets. When reusing existing conversations, the worker updates them to mark as 'whatsapp_campaign' and link to targets. **Dedicated Monitor de CobranÃ§as** provides isolated view with 4 filter options: ðŸ“± Todas, ðŸ“¥ Entrada, ðŸ’¬ Campanha WhatsApp, ðŸ“ž Campanha Voz, preventing high-volume campaign messages from polluting the general supervisor dashboard while maintaining full transfer capabilities. Supervisor Dashboard displays real-time alert badge showing pending payment promises count with one-click access to the cobranÃ§as monitor.

### System Design Choices
- **Admin Tools**: Features for mass-closing abandoned conversations, reprocessing stuck messages, and configuration management.
- **Media Handling**: Supervisors can download WhatsApp images and PDFs, with inline PDF viewing.
- **Security & Compliance**: LGPD/GDPR-compliant logging, protected debug endpoints, and structured error handling.
- **Failure Detection**: Enhanced massive failure detection supporting city-wide outages.
- **Massive Failure Notification**: Automatically notifies clients once via WhatsApp about active failures without blocking conversation flow.
- **Massive Failure Resolution**: Asynchronously notifies all affected customers via WhatsApp upon resolution.
- **Conversation Reopening**: Automatically reopens resolved conversations when a client sends a new message.
- **Intelligent Farewell Detection & Auto-Resolution**: The inactivity follow-up worker detects farewells and automatically resolves the conversation, sending NPS survey.
- **Payment Proof Auto-Resolution**: Automatically resolves conversations upon receipt of payment proof (e.g., Pix receipt), CRM ticket creation, and no further client response.
- **Comprehensive Auto-Closure System**: Redesigned inactivity management schedules follow-ups after every AI response, sending a follow-up message if no response within 10 minutes, and auto-resolving with an NPS survey after 20 more minutes of inactivity. Includes an administrative endpoint for manual cleanup of old conversations.
- **Conversation Assignment Fix**: Ensures that conversations assigned to agents correctly mark `transferred_to_human=true` and `transferredAt`, resolving issues where they appeared in the "IA Atendendo" tab.

### Scalability & Performance
A comprehensive scaling plan in `ESCALABILIDADE.md` details a roadmap to handle 160,000 messages at peak with 15,000 concurrent conversations. This involves queue optimization (partitioned BullMQ), worker scaling (horizontal pod autoscaling), database optimization (PostgreSQL connection pooling, composite indexes, partitioning), OpenAI optimization (embedding cache, intelligent model selection, batch RAG), multi-tier infrastructure roadmap, and extensive observability with Prometheus + Grafana.

## External Dependencies

**Third-Party Services**:
- **OpenAI**: AI Assistants API.
- **Upstash Vector**: Serverless vector database.
- **Upstash Redis**: Serverless Redis.
- **Neon Database**: Serverless PostgreSQL.
- **Evolution API**: WhatsApp integration.

**Key NPM Packages**:
- `@radix-ui/*`: Headless UI components.
- `@tanstack/react-query`: Server state management.
- `drizzle-orm`: Type-safe ORM.
- `express`: Web server framework.
- `react-hook-form`, `zod`: Form handling and validation.
- `tailwindcss`: CSS framework.
- `js-tiktoken`: Token counting for OpenAI models.